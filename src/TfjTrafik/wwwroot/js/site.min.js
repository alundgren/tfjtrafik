var app=angular.module("app",["ngGeolocation"]).controller("ctr",["$scope","$http","$q","$timeout","$geolocation",function(n,i,r,u,f){function c(n,t){var i=localStorage.getItem(n);return i?JSON.parse(i):t}function l(n,t){localStorage.setItem(n,JSON.stringify(t))}function it(){s=c(p,{})}function rt(){l(p,s)}function ut(){t=c(w,{});t.forDate&&t.forDate===moment().format("YYYY-MM-DD")||(t={forDate:moment().format("YYYY-MM-DD")});h=t}function ft(){l(w,h)}function et(){e=c(b,[])}function ot(){e=l(b,e)}function k(n,t,i,f){var e=Array.prototype.slice;return function(){var h=e.call(arguments),s=f(h),o;return s in t?(o=r.defer(),u(function(){o.resolve(t[s])}),o.promise):(o=r.defer(),n.apply(this,h).then(function(n){t[s]=n;i();o.resolve(n)},function(n){o.reject(n)}),o.promise)}}function o(n){return n*(Math.PI/180)}function a(n,t,i,r){var u=o(i-n),f=o(r-t),e=Math.sin(u/2)*Math.sin(u/2)+Math.cos(o(n))*Math.cos(o(i))*Math.sin(f/2)*Math.sin(f/2),s=2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));return 6371*s}function st(n,t,u,f){return r(function(r,e){i.post(initialData.tripsApiUrl,{originId:n,destId:t,passlist:"0",date:u,time:f}).success(function(n){r(n)}).error(function(n){e(n)})})}function ht(n){return r(function(t,r){i.post(initialData.locationApiUrl,{input:n}).success(function(n){t(n)}).error(function(n){r(n)})})}function d(n){for(var t="",i=0;i<n.length;i++)t=t+"_"+n[i];return t}function nt(){var t=moment(),i;n.position&&n.position.date&&t.diff(n.position.date,"minutes")<5?(i=n.position.current.coords,angular.forEach(n.trips,function(n){n.isFarAway=a(i.latitude,i.longitude,n.triggerLocation.lat,n.triggerLocation.lon)>3})):angular.forEach(n.trips,function(n){n.isFarAway=null});angular.forEach(n.nearbyTrips(),function(i){n.getTrip(i.from,i.to,t.format("YYYY-MM-DD"),t.format("HH:mm"))})}function y(){var t=n.trips;f.getCurrentPosition({timeout:6e4,enableHighAccuracy:!0,maximumAge:12e4}).then(function(t){n.position={current:t,isGood:t.coords.accuracy<300,accuracy:t.coords.accuracy.toFixed(),date:moment()};nt()},function(t){n.position={error:t};nt()})}function tt(){y();u(function(){tt()},6e5)}function ct(){it();ut();et();n.addTrip={};n.trips=e;n.currentTrips={};window.scope=n;g=k(st,h,ft,d);v=k(ht,s,rt,d);tt()}var p="tfj.v1.reserobot.cache.location",w="tfj.v1.reserobot.cache.trips",b="tfj.v3.trips",s,h,e,g,v;n.simplifyLocationName=function(n,t){if(!n||!t)return n;var i=/^(.+?)(\([^\(]+\))?$/g.exec(n),r=/^(.+?)(\([^\(]+\))?$/g.exec(t);return i[2]&&r[2]&&i[2]==r[2]?i[1]:n};n.getTrip=function(t,i,r,u){g(t.id,i.id,r,u).then(function(r){var u=[];angular.forEach(r.Trip,function(n){var t=n.LegList.Leg[0],i=moment(t.Origin.date+" "+t.Origin.time,"YYYY-MM-DD HH:mm:ss",!0),r=moment(t.Destination.date+" "+t.Destination.time,"YYYY-MM-DD HH:mm:ss",!0),f,e,o;t.Origin.date==t.Destination.date?(f=i.format("HH:mm"),e=r.format("HH:mm")):(f=i.format("YYYY-MM-DD HH:mm"),e=r.format("YYYY-MM-DD HH:mm"));o={originCompactDateTime:f,destinationCompactDateTime:e,durationInMinutes:r.diff(i,"minutes")};u.push(o)});n.currentTrips[t.id+"_"+i.id]=u},function(){})};n.searchFromLocationViableHits=function(){if(!n.addTrip.searchFromLocationHits)return[];var t=[];return angular.forEach(n.addTrip.searchFromLocationHits,function(i){var r=a(n.position.current.coords.latitude,n.position.current.coords.longitude,i.lat,i.lon);i.distance=r;i.distance<75&&t.push(i)}),t};n.searchFromLocation=function(){n.addTrip.searchFromLocationInput&&v(n.addTrip.searchFromLocationInput).then(function(t){n.addTrip.searchFromLocationHits=t.StopLocation},function(n){console.log(n)})};n.pickFrom=function(t){n.addTrip.from=t};n.pickTo=function(t){n.addTrip.to=t};n.searchToLocationViableHits=function(){if(!n.addTrip.searchToLocationHits)return[];var t=[];return angular.forEach(n.addTrip.searchToLocationHits,function(i){var r=a(n.position.current.coords.latitude,n.position.current.coords.longitude,i.lat,i.lon);i.distance=r;i.distance<75&&t.push(i)}),t};n.searchToLocation=function(){n.addTrip.searchToLocationInput&&v(n.addTrip.searchToLocationInput).then(function(t){n.addTrip.searchToLocationHits=t.StopLocation},function(n){console.log(n)})};n.onShowAddTrip=function(){n.addTrip={};f.getCurrentPosition({timeout:6e4,enableHighAccuracy:!0,maximumAge:12e4}).then(function(t){n.position={current:t,isGood:t.coords.accuracy<300,accuracy:t.coords.accuracy.toFixed()}},function(t){n.position={error:t}})};n.addTripNow=function(){n.trips.push({from:n.addTrip.from,to:n.addTrip.to,triggerLocation:{lat:n.position.current.coords.latitude,lon:n.position.current.coords.longitude}});ot();$("#closeAddTrip").click();y()};n.nearbyTrips=function(){var t=[];return angular.forEach(n.trips,function(n){n.isFarAway||t.push(n)}),t};n.current=function(t){return n.currentTrips[t.from.id+"_"+t.to.id]};n.refresh=function(){y()};ct()}]);